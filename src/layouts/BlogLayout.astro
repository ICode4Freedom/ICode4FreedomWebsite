---
import BaseLayout from "./BaseLayout.astro";
import AudioTrack from "../components/AudioTrack.astro";
import ImageGallery from "../components/ImageGallery.astro";
import BlogTyping from "../scripts/BlogTyping.astro";
import ReadingProgress from "../components/ReadingProgress.astro";
import ImageLightbox from "../components/ImageLightbox.astro";
import RelatedPosts from "../components/RelatedPosts.astro";
import Comments from "../components/Comments.astro";

const { frontmatter, url, rawContent } = Astro.props;

// Check if this is a blog post (has pubDate and tags) or a standalone page
const isBlogPost = !!frontmatter.pubDate && url?.includes('/blogs/');

// Calculate reading time (avg 200 words per minute)
const content = rawContent ? rawContent() : '';
const wordCount = content.split(/\s+/).filter((word: string) => word.length > 0).length;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Get prev/next posts for navigation and related posts
let prevPost = null;
let nextPost = null;
let allPostsForRelated: any[] = [];

if (isBlogPost) {
  const allPostsRaw = Object.values(import.meta.glob('../pages/blogs/*.md', { eager: true }));
  const allPosts = allPostsRaw
    .filter((post: any) => post.rawContent && post.rawContent().trim().length > 0)
    .sort((a: any, b: any) => new Date(b.frontmatter.pubDate).getTime() - new Date(a.frontmatter.pubDate).getTime());

  const currentIndex = allPosts.findIndex((post: any) => post.url === url);
  prevPost = currentIndex >= 0 && currentIndex < allPosts.length - 1 ? {
    url: (allPosts[currentIndex + 1] as any).url,
  } : null;
  nextPost = currentIndex > 0 ? {
    url: (allPosts[currentIndex - 1] as any).url,
  } : null;

  // Prepare posts for RelatedPosts component
  allPostsForRelated = allPosts.map((post: any) => ({
    url: post.url,
    title: post.frontmatter.title,
    tags: post.frontmatter.tags || [],
    pubDate: post.frontmatter.pubDate
  }));
}

// Format date nicely (only if pubDate exists)
let formattedDate = '';
let pubDateISO = '';
if (frontmatter.pubDate) {
  const pubDate = new Date(frontmatter.pubDate);
  formattedDate = pubDate.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  pubDateISO = pubDate.toISOString();
}

// Create URL slug from title
const titleSlug = frontmatter.title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/(^-|-$)/g, '');

// OG Image: use post image or generate path
const ogImage = frontmatter.image || `/og/${titleSlug}.png`;
---

<BaseLayout 
  title={frontmatter.title}
  description={frontmatter.description}
  image={ogImage}
  article={isBlogPost}
  publishedTime={pubDateISO}
  tags={frontmatter.tags}
>
  <ReadingProgress />
  <ImageLightbox />
  
  <article class="blog-article">
    <div class="blog-container">
      
      <!-- Terminal-style Header -->
      <header class="blog-header">
        <div class="breadcrumb">
          <span class="path">~/blogs/<span class="current">{titleSlug}</span></span>
        </div>
        
        <h1 class="title">{frontmatter.title}</h1>
        
        <div class="meta">
          {formattedDate && (
            <time class="date" datetime={pubDateISO}>
              <span class="date-label">posted:</span> {formattedDate}
            </time>
          )}
          
          {isBlogPost && (
            <span class="reading-time">
              <span class="reading-label">read:</span> {readingTime} min
            </span>
          )}
          
          {frontmatter.trackName && <AudioTrack />}
        </div>
        
        {frontmatter.tags && frontmatter.tags.length > 0 && (
          <div class="tags">
            {frontmatter.tags.map((tag: string) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        )}
      </header>

      <hr class="divider" />

      <!-- Main Content -->
      <div class="content-wrapper">
        <div class="text-content">
          <BlogTyping>
            <slot />
          </BlogTyping>
        </div>
        
        {frontmatter.images && frontmatter.images.length > 0 && (
          <aside class="image-sidebar">
            <ImageGallery images={frontmatter.images} altPrefix={frontmatter.title} />
          </aside>
        )}
      </div>

      <!-- Related Posts -->
      {isBlogPost && frontmatter.tags && frontmatter.tags.length > 0 && (
        <RelatedPosts 
          currentUrl={url} 
          currentTags={frontmatter.tags} 
          allPosts={allPostsForRelated}
          maxPosts={3}
        />
      )}

      <!-- Comments Section (only on blog posts) -->
      {isBlogPost && (
        <Comments title={frontmatter.title} />
      )}

      <!-- Footer Section -->
      <footer class="blog-footer">
        <div class="footer-nav">
          {prevPost ? (
            <a href={prevPost.url} class="nav-btn">‚Üê Prev</a>
          ) : (
            <span class="nav-btn disabled">‚Üê Prev</span>
          )}
          <button class="nav-btn" id="share-btn" data-title={frontmatter.title} data-description={frontmatter.description}>Share</button>
          {nextPost ? (
            <a href={nextPost.url} class="nav-btn">Next ‚Üí</a>
          ) : (
            <span class="nav-btn disabled">Next ‚Üí</span>
          )}
        </div>
        
        <form 
          action="https://buttondown.com/api/emails/embed-subscribe/icode4freedom"
          method="post"
          target="popupwindow"
          class="subscribe-inline"
        >
          <input type="email" name="email" placeholder="your@email.com" required />
          <button type="submit">Subscribe</button>
        </form>
      </footer>
      
      <script>
        document.getElementById('share-btn')?.addEventListener('click', () => {
          const btn = document.getElementById('share-btn');
          const title = btn?.getAttribute('data-title') || document.title;
          const desc = btn?.getAttribute('data-description') || '';
          const url = window.location.href;
          
          // Create engaging share text
          const shareText = `üìñ "${title}"\n\n${desc}\n\nRead it here:`;
          
          const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}&via=ICode4Freedom`;
          window.open(twitterUrl, '_blank', 'width=550,height=420');
        });
      </script>
      
    </div>
  </article>
</BaseLayout>

<style>
  .blog-article {
    width: 100%;
    padding: 2rem 1rem;
  }
  
  .blog-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }
  
  /* Header Styles */
  .blog-header {
    margin-bottom: 2rem;
  }
  
  .breadcrumb {
    margin-bottom: 1rem;
  }
  
  .path {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--fg-d);
  }
  
  .path .current {
    color: var(--terminal-green);
  }
  
  .title {
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    margin: 0.5rem 0 1rem;
    line-height: 1.2;
    color: var(--fg);
  }
  
  .meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .date {
    font-size: 0.9rem;
    color: var(--fg-d);
  }
  
  .date-label,
  .reading-label {
    color: var(--terminal-green);
  }
  
  .reading-time {
    font-size: 0.9rem;
    color: var(--fg-d);
  }
  
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .tag {
    font-size: 0.7rem;
    color: var(--fg-d);
    font-family: var(--font-mono);
  }
  
  .tag:not(:last-child)::after {
    content: " ¬∑";
  }
  
  /* Divider */
  .divider {
    border: none;
    border-top: 1px dashed var(--fg-d);
    margin: 2rem 0;
  }
  
  /* Content Wrapper */
  .content-wrapper {
    display: flex;
    gap: 2rem;
    position: relative;
  }
  
  .text-content {
    flex: 1;
    min-width: 0;
  }
  
  .image-sidebar {
    width: 250px;
    flex-shrink: 0;
    position: sticky;
    top: 2rem;
    align-self: flex-start;
  }
  
  /* Footer Styles */
  .blog-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1.5rem 0;
    margin-top: 1rem;
    border-top: 1px solid var(--fg-d);
  }
  
  .footer-nav {
    display: flex;
    gap: 0.5rem;
  }
  
  .nav-btn {
    padding: 0.5rem 1rem;
    background: transparent;
    border: 1px solid var(--fg-d);
    border-radius: 4px;
    color: var(--fg);
    text-decoration: none;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }
  
  .nav-btn:hover:not(.disabled) {
    border-color: var(--terminal-green);
    color: var(--terminal-green);
  }
  
  .nav-btn.disabled {
    opacity: 0.3;
    cursor: default;
  }
  
  .subscribe-inline {
    display: flex;
    gap: 0.5rem;
  }
  
  .subscribe-inline input[type="email"] {
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid var(--fg-d);
    border-radius: 4px;
    color: var(--fg);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    width: 160px;
    transition: border-color 0.2s;
  }
  
  .subscribe-inline input[type="email"]::placeholder {
    color: var(--fg-d);
  }
  
  .subscribe-inline input[type="email"]:focus {
    outline: none;
    border-color: var(--terminal-green);
  }
  
  .subscribe-inline button {
    padding: 0.5rem 1rem;
    background: var(--terminal-green);
    border: none;
    border-radius: 4px;
    color: var(--bg);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  
  .subscribe-inline button:hover {
    opacity: 0.85;
  }
  
  @media (max-width: 600px) {
    .blog-footer {
      flex-direction: column;
      gap: 1rem;
    }
    
    .subscribe-inline input[type="email"] {
      width: 140px;
    }
  }
  
  /* Responsive */
  @media (max-width: 900px) {
    .content-wrapper {
      flex-direction: column;
    }
    
    .image-sidebar {
      width: 100%;
      position: static;
      margin-top: 2rem;
    }
  }
  
  @media (max-width: 600px) {
    .blog-container {
      padding: 0 1rem;
    }
  }
</style>
