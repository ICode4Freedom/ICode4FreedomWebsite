---
// Terminal component with interactive commands
// Commands: help, clear, blogs, about, contact

interface Props {
  blogs?: Array<{
    title: string;
    url: string;
    description: string;
    tags: string[];
  }>;
}

const { blogs = [] } = Astro.props;
---

<div class="terminal">
  <div class="terminal-header">
    <div class="terminal-buttons">
      <span class="terminal-btn close"></span>
      <span class="terminal-btn minimize"></span>
      <span class="terminal-btn maximize"></span>
    </div>
    <span class="terminal-title">icode4freedom@terminal ~ </span>
  </div> 
  <div class="terminal-body">
    <div id="output">
      <div class="output-line ascii-art">
{`
 â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—
 â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
 â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘
 â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•     â•šâ•â•
          F R E E D O M
`}
      </div>
      <div class="output-line">Welcome to ICode4Freedom Terminal v1.0</div>
      <div class="output-line">Type <span class="cmd-highlight">help</span> for available commands.</div>
      <div class="output-line">&nbsp;</div>
    </div>
    <div class="input-line">
      <span class="prompt">$ </span>
      <input type="text" id="command-input" autocomplete="off" spellcheck="false">
      <span class="cursor">_</span>
    </div>
  </div>
</div>

<!-- Pass blog data to JS -->
<script define:vars={{ blogs }}>
  window.__TERMINAL_BLOGS__ = blogs;
</script>

<script>
  const output = document.getElementById('output');
  const input = document.getElementById('command-input') as HTMLInputElement;
  const blogs = (window as any).__TERMINAL_BLOGS__ || [];
  
  const commandHistory: string[] = [];
  let historyIndex = -1;

  const commands: Record<string, (args: string[]) => string | string[]> = {
    help: () => [
      '',
      'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
      'â•‘           AVAILABLE COMMANDS               â•‘',
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£',
      'â•‘  help     - Show this help message         â•‘',
      'â•‘  clear    - Clear the terminal             â•‘',
      'â•‘  blogs    - List all blog posts            â•‘',
      'â•‘  read <n> - Preview blog post #n           â•‘',
      'â•‘  tags     - Show all available tags        â•‘',
      'â•‘  about    - About ICode4Freedom            â•‘',
      'â•‘  contact  - Contact information            â•‘',
      'â•‘  whoami   - Who am I?                      â•‘',
      'â•‘  date     - Show current date/time         â•‘',
      'â•‘  echo     - Echo back your text            â•‘',
      'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      ''
    ],
    
    clear: () => {
      if (output) output.innerHTML = '';
      return '';
    },
    
    blogs: () => {
      if (blogs.length === 0) {
        return 'No blog posts found.';
      }
      const lines = ['', 'ğŸ“š BLOG POSTS:', 'â”€'.repeat(40)];
      blogs.forEach((blog: any, i: number) => {
        lines.push(`  [${i + 1}] ${blog.title}`);
        if (blog.tags && blog.tags.length > 0) {
          lines.push(`      Tags: ${blog.tags.join(', ')}`);
        }
      });
      lines.push('â”€'.repeat(40));
      lines.push('Use "read <number>" to preview a post');
      lines.push('');
      return lines;
    },
    
    read: (args: string[]) => {
      const num = parseInt(args[0]);
      if (isNaN(num) || num < 1 || num > blogs.length) {
        return `Usage: read <1-${blogs.length}>`;
      }
      const blog = blogs[num - 1];
      return [
        '',
        'â•'.repeat(50),
        `ğŸ“„ ${blog.title}`,
        'â•'.repeat(50),
        '',
        `Description: ${blog.description}`,
        '',
        blog.tags?.length ? `Tags: ${blog.tags.join(', ')}` : '',
        '',
        `â†’ Read full post: ${blog.url}`,
        '',
        'â”€'.repeat(50),
        ''
      ].filter(l => l !== undefined);
    },
    
    tags: () => {
      const allTags = new Set<string>();
      blogs.forEach((blog: any) => {
        if (blog.tags) {
          blog.tags.forEach((tag: string) => allTags.add(tag));
        }
      });
      if (allTags.size === 0) {
        return 'No tags found.';
      }
      return ['', 'ğŸ·ï¸  AVAILABLE TAGS:', 'â”€'.repeat(30), ...Array.from(allTags).map(t => `  â€¢ ${t}`), ''];
    },
    
    about: () => [
      '',
      'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
      'â•‘              ABOUT ICODE4FREEDOM              â•‘',
      'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£',
      'â•‘  A blog about coding, freedom, and the       â•‘',
      'â•‘  intersection of technology and life.        â•‘',
      'â•‘                                              â•‘',
      'â•‘  Built with Astro + Terminal Aesthetics      â•‘',
      'â•‘  Powered by curiosity and caffeine â˜•        â•‘',
      'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
      ''
    ],
    
    contact: () => [
      '',
      'ğŸ“¬ CONTACT:',
      'â”€'.repeat(30),
      '  Email: michael@icode4freedom.com',
      '  GitHub: github.com/ICode4Freedom',
      ''
    ],
    
    whoami: () => 'visitor@icode4freedom.com',
    
    date: () => new Date().toLocaleString(),
    
    echo: (args: string[]) => args.join(' ') || '',
    
    neofetch: () => [
      '',
      '       â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„        visitor@icode4freedom',
      '      â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
      '     â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ      OS: Web Browser',
      '    â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ     Host: icode4freedom.com',
      '   â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ    Kernel: Astro v5.x',
      '   â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ    Uptime: Since you arrived',
      '   â–ˆâ–‘â–‘â–€â–€â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–€â–€â–‘â–‘â–‘â–ˆ     Shell: Terminal v1.0',
      '   â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ     Theme: Matrix Dark',
      '   â–ˆâ–‘â–‘â–‘â–‘â–‘â–ˆâ–€â–€â–€â–€â–€â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–ˆ     Terminal: 80x24',
      '   â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ     CPU: Your Brain',
      '    â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ      Memory: Hopefully good',
      '     â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ       ',
      '      â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆ        ',
      ''
    ]
  };

  function printOutput(text: string | string[]) {
    if (!output) return;
    const lines = Array.isArray(text) ? text : [text];
    lines.forEach(line => {
      const div = document.createElement('div');
      div.className = 'output-line';
      div.textContent = line;
      output.appendChild(div);
    });
  }

  function processCommand(cmd: string) {
    const trimmed = cmd.trim();
    if (!trimmed) return;
    
    // Add command echo
    printOutput(`$ ${trimmed}`);
    
    // Add to history
    commandHistory.unshift(trimmed);
    historyIndex = -1;
    
    const [command, ...args] = trimmed.toLowerCase().split(/\s+/);
    
    if (commands[command]) {
      const result = commands[command](args);
      if (result) {
        printOutput(result);
      }
    } else {
      printOutput(`Command not found: ${command}. Type "help" for available commands.`);
    }
    
    // Scroll to bottom
    const terminalBody = document.querySelector('.terminal-body');
    if (terminalBody) {
      terminalBody.scrollTop = terminalBody.scrollHeight;
    }
  }

  if (input) {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        processCommand(input.value);
        input.value = '';
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
          historyIndex++;
          input.value = commandHistory[historyIndex];
        }
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
          historyIndex--;
          input.value = commandHistory[historyIndex];
        } else {
          historyIndex = -1;
          input.value = '';
        }
      }
    });
    
    // Focus input when clicking anywhere in terminal
    document.querySelector('.terminal')?.addEventListener('click', () => {
      input.focus();
    });
  }
</script>

<style>
  .terminal {
    width: 100%;
    max-width: 55rem;
    background: var(--term-bg);
    border-radius: 8px;
    border: 2px solid var(--term-bc);
    font-family: var(--font-mono);
    font-size: 14px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  .terminal-header {
    background: linear-gradient(to bottom, #3c3c3c, #2a2a2a);
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid #1a1a1a;
  }

  .terminal-buttons {
    display: flex;
    gap: 8px;
  }

  .terminal-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    cursor: pointer;
  }

  .terminal-btn.close { background: #ff5f56; }
  .terminal-btn.minimize { background: #ffbd2e; }
  .terminal-btn.maximize { background: #27ca40; }

  .terminal-title {
    color: #999;
    font-size: 12px;
  }

  .terminal-body {
    padding: 12px;
    height: 400px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--fg) var(--term-bg);
  }

  .output-line {
    color: var(--term-tc);
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .output-line.ascii-art {
    color: var(--terminal-green);
    font-size: 10px;
    line-height: 1.1;
  }

  .cmd-highlight {
    color: var(--terminal-green);
    font-weight: bold;
  }

  .input-line {
    display: flex;
    align-items: center;
    margin-top: 4px;
  }

  .prompt {
    color: var(--terminal-green);
    margin-right: 8px;
    font-weight: bold;
  }

  #command-input {
    background: transparent;
    border: none;
    color: var(--term-tc);
    font-family: var(--font-mono);
    font-size: 14px;
    flex: 1;
    outline: none;
    caret-color: transparent;
  }

  .cursor {
    color: var(--terminal-green);
    animation: blink 1s steps(1) infinite;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }
</style>
