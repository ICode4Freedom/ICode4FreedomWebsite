---
// Pagefind Search Component
// Full-text search across all blog posts
---

<div class="search-container">
  <button id="search-trigger" class="search-trigger" aria-label="Search">
    <span class="search-icon">üîç</span>
    <span class="search-text">Search</span>
    <kbd class="search-kbd">/</kbd>
  </button>
</div>

<div id="search-modal" class="search-modal" style="display: none;">
  <div class="search-backdrop"></div>
  <div class="search-dialog">
    <div class="search-header">
      <span class="search-title">Search Posts</span>
      <button class="search-close" aria-label="Close">√ó</button>
    </div>
    <div id="search-content"></div>
  </div>
</div>

<script is:inline>
  async function initSearch() {
    const trigger = document.getElementById('search-trigger');
    const modal = document.getElementById('search-modal');
    const backdrop = modal?.querySelector('.search-backdrop');
    const closeBtn = modal?.querySelector('.search-close');
    const content = document.getElementById('search-content');
    
    let pagefindLoaded = false;

    async function loadPagefind() {
      if (pagefindLoaded) return;
      
      // Load CSS
      if (!document.querySelector('link[href*="pagefind-ui.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/pagefind/pagefind-ui.css';
        document.head.appendChild(link);
      }
      
      try {
        const pagefindModule = await import('/pagefind/pagefind-ui.js');
        const PagefindUI = pagefindModule.PagefindUI;
        new PagefindUI({
          element: '#search-content',
          showSubResults: true,
          showImages: false,
        });
        pagefindLoaded = true;
      } catch (e) {
        if (content) {
          content.innerHTML = '<p class="search-error">Search not available. Try refreshing.</p>';
        }
      }
    }

    function openModal() {
      modal!.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      loadPagefind();
      setTimeout(() => {
        const input = content?.querySelector('input');
        input?.focus();
      }, 100);
    }

    function closeModal() {
      modal!.style.display = 'none';
      document.body.style.overflow = '';
    }

    trigger?.addEventListener('click', openModal);
    backdrop?.addEventListener('click', closeModal);
    closeBtn?.addEventListener('click', closeModal);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Open with /
      if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes((e.target as Element).tagName)) {
        e.preventDefault();
        openModal();
      }
      // Close with Escape
      if (e.key === 'Escape' && modal?.style.display === 'flex') {
        closeModal();
      }
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }
</script>

<style>
  .search-container {
    display: inline-block;
  }

  .search-trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.75rem;
    background: var(--ui-bg);
    border: 1px solid var(--fg-d);
    border-radius: 4px;
    color: var(--fg);
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .search-trigger:hover {
    border-color: var(--terminal-green);
    color: var(--terminal-green);
  }

  .search-icon {
    font-size: 0.9rem;
  }

  .search-kbd {
    background: var(--bg);
    border: 1px solid var(--fg-d);
    border-radius: 3px;
    padding: 0.1rem 0.4rem;
    font-size: 0.75rem;
    color: var(--fg-d);
  }

  /* Modal */
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
  }

  .search-dialog {
    position: relative;
    width: 100%;
    max-width: 600px;
    max-height: 70vh;
    margin: 0 1rem;
    background: var(--bg);
    border: 2px solid var(--terminal-green);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .search-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--fg-d);
  }

  .search-title {
    font-family: var(--font-mono);
    color: var(--terminal-green);
  }

  .search-close {
    background: none;
    border: none;
    color: var(--fg);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .search-close:hover {
    color: var(--terminal-green);
  }

  #search-content {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
  }

  .search-error {
    color: var(--fg-d);
    text-align: center;
    padding: 2rem;
  }

  /* Pagefind UI Overrides */
  :global(.pagefind-ui) {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--terminal-green);
    --pagefind-ui-text: var(--fg);
    --pagefind-ui-background: var(--bg);
    --pagefind-ui-border: var(--fg-d);
    --pagefind-ui-tag: var(--ui-bg);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 4px;
    --pagefind-ui-font: var(--font-mono);
  }

  :global(.pagefind-ui__search-input) {
    background: var(--bg) !important;
    color: var(--fg) !important;
  }

  :global(.pagefind-ui__result-link) {
    color: var(--terminal-green) !important;
  }

  @media (max-width: 600px) {
    .search-text {
      display: none;
    }

    .search-kbd {
      display: none;
    }
  }
</style>
