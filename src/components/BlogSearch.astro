---
// Blog Search/Filter component
// Allows filtering blogs by text and tags

interface Props {
  allTags: string[];
}

const { allTags } = Astro.props;
---

<div class="blog-search">
  <div class="search-bar">
    <span class="search-icon">üîç</span>
    <input 
      type="text" 
      id="blog-search-input" 
      placeholder="Search blogs..." 
      autocomplete="off"
    >
    <button id="clear-search" class="clear-btn" title="Clear search">√ó</button>
  </div>
  
  {allTags.length > 0 && (
    <div class="tag-filters">
      <span class="filter-label">Filter by tag:</span>
      <div class="tag-buttons">
        <button class="tag-btn active" data-tag="all">All</button>
        {allTags.map(tag => (
          <button class="tag-btn" data-tag={tag}>{tag}</button>
        ))}
      </div>
    </div>
  )}
  
  <div id="search-results-info" class="results-info"></div>
</div>

<script>
  const searchInput = document.getElementById('blog-search-input') as HTMLInputElement;
  const clearBtn = document.getElementById('clear-search');
  const tagButtons = document.querySelectorAll('.tag-btn');
  const resultsInfo = document.getElementById('search-results-info');
  const blogList = document.querySelector('.blog-list-content');
  
  let activeTag = 'all';
  let searchQuery = '';

  function filterBlogs() {
    if (!blogList) return;
    
    const blogs = blogList.querySelectorAll('li.blogpost');
    let visibleCount = 0;
    
    blogs.forEach((blog) => {
      const title = blog.querySelector('.title-link')?.textContent?.toLowerCase() || '';
      const description = blog.querySelector('.blog-info p:last-child')?.textContent?.toLowerCase() || '';
      const tagsEl = blog.querySelector('.tags');
      const tags = tagsEl?.textContent?.toLowerCase() || '';
      
      // Check search query match
      const matchesSearch = searchQuery === '' || 
        title.includes(searchQuery) || 
        description.includes(searchQuery) ||
        tags.includes(searchQuery);
      
      // Check tag filter match
      const matchesTag = activeTag === 'all' || tags.includes(activeTag.toLowerCase());
      
      // Show/hide based on both filters
      const shouldShow = matchesSearch && matchesTag;
      (blog as HTMLElement).style.display = shouldShow ? '' : 'none';
      
      if (shouldShow) visibleCount++;
    });
    
    // Update results info
    if (resultsInfo) {
      if (searchQuery || activeTag !== 'all') {
        resultsInfo.textContent = `Showing ${visibleCount} of ${blogs.length} posts`;
        resultsInfo.style.display = 'block';
      } else {
        resultsInfo.style.display = 'none';
      }
    }
  }

  // Search input handler
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
      filterBlogs();
    });
  }

  // Clear button handler
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      if (searchInput) {
        searchInput.value = '';
        searchQuery = '';
        filterBlogs();
      }
    });
  }

  // Tag filter handlers
  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      tagButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      activeTag = btn.getAttribute('data-tag') || 'all';
      filterBlogs();
    });
  });
</script>

<style>
  .blog-search {
    margin-bottom: 1.5rem;
    padding: 0 0.5rem;
  }

  .search-bar {
    display: flex;
    align-items: center;
    background: var(--ui-bg);
    border: 2px solid var(--fg);
    border-radius: 4px;
    padding: 0.5rem 0.75rem;
    gap: 0.5rem;
  }

  .search-icon {
    font-size: 1rem;
    opacity: 0.7;
  }

  #blog-search-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--fg);
    font-family: var(--font-mono);
    font-size: 1rem;
    outline: none;
  }

  #blog-search-input::placeholder {
    color: var(--fg-d);
    opacity: 0.6;
  }

  .clear-btn {
    background: transparent;
    border: none;
    color: var(--fg-d);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 0.25rem;
    line-height: 1;
    opacity: 0.6;
    transition: opacity 0.2s;
  }

  .clear-btn:hover {
    opacity: 1;
    color: var(--fg);
  }

  .tag-filters {
    margin-top: 0.75rem;
  }

  .filter-label {
    font-size: 0.85rem;
    color: var(--fg-d);
    display: block;
    margin-bottom: 0.5rem;
  }

  .tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-btn {
    background: var(--ui-bg);
    border: 1px solid var(--fg-d);
    color: var(--fg-d);
    font-family: var(--font-mono);
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tag-btn:hover {
    border-color: var(--fg);
    color: var(--fg);
  }

  .tag-btn.active {
    background: var(--fg);
    color: var(--bg);
    border-color: var(--fg);
  }

  .results-info {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    color: var(--fg-d);
    display: none;
  }
</style>
